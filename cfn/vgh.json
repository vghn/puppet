{
  "Description": "VGH Puppet v0.0.1",

  "Parameters": {
    "EnvType": {
      "Type": "String",
      "Description": "Environment type",
      "Default": "production"
    },
    "KeyName": {
      "Type": "AWS::EC2::KeyPair::KeyName",
      "Description": "Amazon EC2 key pair"
    },
    "AssetsBucket": {
      "Type": "String",
      "Description": "The S3 bucket containing the assets"
    },
    "AssetsKeyPrefix": {
      "Type": "String",
      "Description": "The S3 assets key prefix"
    },
    "PuppetMaster": {
      "Type": "String",
      "Description": "The address of the Puppet Master server"
    },
    "CASSLS3Path": {
      "Type": "String",
      "Description": "The S3 path to the certificates backup"
    },
    "ZeusAMIId": {
      "Type": "String",
      "Description": "The AMI Id for the Zeus ASG"
    },
    "ZeusDesiredCapacity": {
      "Type": "Number",
      "Default": "1",
      "Description": "The AMI Id for the Zeus ASG"
    },
    "PuppetServerDesiredCount": {
      "Type": "Number",
      "Default": "1",
      "Description": "The AMI Id for the Zeus ASG"
    },
    "SSHLocations": {
      "Type": "CommaDelimitedList",
      "Description": "The IP address ranges that can be used to SSH to the EC2 instances"
    },
    "DBEngine": {
      "Default": "mariadb",
      "Description": "MySQL engine",
      "Type": "String",
      "AllowedValues": ["MySQL", "mariadb", "postgres"],
      "ConstraintDescription": "must select a valid database engine"
    },
    "DBName": {
      "Default": "myDatabase",
      "Description": "MySQL database name",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "64",
      "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*",
      "ConstraintDescription": "must begin with a letter and contain only alphanumeric characters."
    },
    "DBUser": {
      "NoEcho": "true",
      "Description": "Username for MySQL database access",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "16",
      "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*",
      "ConstraintDescription": "must begin with a letter and contain only alphanumeric characters."
    },
    "DBPassword": {
      "NoEcho": "true",
      "Description": "Password for MySQL database access",
      "Type": "String",
      "MinLength": "8",
      "MaxLength": "41",
      "AllowedPattern": "[a-zA-Z0-9]*",
      "ConstraintDescription": "must contain only alphanumeric characters."
    },
    "SSLCertificateId": {
      "Description": "The ARN of the SSL certificate to use",
      "Type": "String"
    },
    "LogServer": {
      "Description": "The centralized logging server",
      "Type": "String"
    },
    "LogPort": {
      "Description": "The centralized logging server's port",
      "Type": "String"
    },
    "VPCTemplateKey": {
      "Type": "String",
      "Description": "The key of the template for the VPC nested stack"
    },
    "SGTemplateKey": {
      "Type": "String",
      "Description": "The key of the template for the SG nested stack"
    },
    "IAMTemplateKey": {
      "Type": "String",
      "Description": "The key of the template for the IAM nested stack"
    },
    "RDSTemplateKey": {
      "Type": "String",
      "Description": "The key of the template for the RDS nested stack"
    }
  },

  "Resources": {
    "ELB": {
      "Type": "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties": {
        "SecurityGroups": [{"Fn::GetAtt": ["SG", "Outputs.ELBSecurityGroup"]}],
        "Subnets": [
          {"Fn::GetAtt": ["VPC", "Outputs.Subnet1"]},
          {"Fn::GetAtt": ["VPC", "Outputs.Subnet2"]},
          {"Fn::GetAtt": ["VPC", "Outputs.Subnet3"]},
          {"Fn::GetAtt": ["VPC", "Outputs.Subnet4"]}
        ],
        "CrossZone": "true",
        "Listeners": [
          {"LoadBalancerPort": "443", "Protocol": "HTTPS", "InstancePort": "80", "InstanceProtocol": "HTTP", "SSLCertificateId": {"Ref": "SSLCertificateId"}},
          {"LoadBalancerPort": "8140", "Protocol": "TCP", "InstancePort": "8140", "InstanceProtocol": "TCP"}
        ],
        "HealthCheck": {
          "Target": "HTTP:51678/v1/metadata",
          "HealthyThreshold": "2",
          "UnhealthyThreshold": "6",
          "Interval": "10",
          "Timeout": "5"
        },
        "ConnectionDrainingPolicy": {"Enabled": "true", "Timeout": "60"}
      }
    },

    "Zeus": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "LaunchConfigurationName": {"Ref": "LaunchZeusInstance"},
        "VPCZoneIdentifier": [
          {"Fn::GetAtt": ["VPC", "Outputs.Subnet1"]},
          {"Fn::GetAtt": ["VPC", "Outputs.Subnet2"]},
          {"Fn::GetAtt": ["VPC", "Outputs.Subnet3"]},
          {"Fn::GetAtt": ["VPC", "Outputs.Subnet4"]}
        ],
        "MinSize": "0",
        "MaxSize": "1",
        "DesiredCapacity": {"Ref": "ZeusDesiredCapacity"},
        "HealthCheckType": "ELB",
        "HealthCheckGracePeriod": "600",
        "Cooldown": "600",
        "LoadBalancerNames": [{"Ref": "ELB"}],
        "TerminationPolicies": ["OldestInstance", "Default"],
        "Tags": [
          {"Key": "Role", "Value": "zeus", "PropagateAtLaunch": "true"},
          {"Key": "Name", "Value": {"Fn::Join": ["-" , [{"Ref": "AWS::StackName"}, "Zeus"]]}, "PropagateAtLaunch": "true"}
        ]
      },
      "UpdatePolicy" : {
        "AutoScalingRollingUpdate": {
          "MaxBatchSize": "1",
          "MinInstancesInService": "0",
          "PauseTime": "PT10M",
          "WaitOnResourceSignals": "true"
        }
      }
    },
    "LaunchZeusInstance": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "InstanceType": "t2.micro",
        "KeyName": {"Ref": "KeyName"},
        "AssociatePublicIpAddress": "true",
        "ImageId": {"Ref": "ZeusAMIId"},
        "SecurityGroups": [{"Fn::GetAtt": ["SG", "Outputs.InstanceSecurityGroup"]}],
        "IamInstanceProfile": {"Fn::GetAtt": ["IAM", "Outputs.InstanceProfile"]},
        "UserData": {"Fn::Base64": {"Fn::Join": ["" , [
          "#!/usr/bin/env bash\n",
          "set -euo pipefail\n",
          "IFS=$'\\n\\t'", "\n",

          "echo 'IN_PROGRESS' | tee /var/lib/cloud/instance/status_cfn\n",

          "signal_exit(){\n",
          "  /usr/local/bin/cfn-signal --exit-code ${1:-0}",
          "    --resource Zeus",
          "    --stack ", {"Ref": "AWS::StackName"},
          "    --region ", {"Ref": "AWS::Region"},
          "    || true", "\n",
          "}\n",
          "trap 'signal_exit $?' EXIT INT TERM\n",

          "echo 'Write facts'\n",
          "mkdir -p /etc/puppetlabs/facter/facts.d\n",
          "cat << EOF > /etc/puppetlabs/facter/facts.d/aws-env.yaml\n",
          "---\n",
          "aws_cfn_name: ", {"Ref": "AWS::StackName"}, "\n",
          "aws_cfn_env_type: ", {"Ref": "EnvType"}, "\n",
          "aws_cfn_ecs_cluster: ", {"Ref": "ECSCluster"}, "\n",
          "aws_cfn_assets_bucket: ", {"Ref": "AssetsBucket"}, "\n",
          "aws_cfn_assets_key_prefix: ", {"Ref": "AssetsKeyPrefix"}, "\n",
          "aws_cfn_rds_db_endpoint: ", {"Fn::GetAtt": ["RDS", "Outputs.DBEndpoint"]}, "\n",
          "EOF\n",

          "echo 'Redeploy R10K'\n",
          "/opt/puppetlabs/puppet/bin/r10k deploy environment --puppetfile --verbose\n",

          "echo 'Set puppet configuration'\n",
          "/opt/puppetlabs/bin/puppet config set certname \"$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\" --section main\n",
          "/opt/puppetlabs/bin/puppet config set server ", {"Ref": "PuppetMaster"}, " --section main\n",
          "/opt/puppetlabs/bin/puppet config set environment ", {"Ref": "EnvType"}, " --section main\n",

          "echo 'Remove old puppet certificates'\n",
          "rm -r /etc/puppetlabs/puppet/ssl\n",

          "echo 'Create new csr attributes file'\n",
          "cat << EOF > /etc/puppetlabs/puppet/csr_attributes.yaml\n",
          "---\n",
          "extension_requests:\n",
          "  pp_role: zeus\n",
          "  pp_project: vpm\n",
          "  pp_instance_id: $(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n",
          "  pp_image_name: $(curl -s http://169.254.169.254/latest/meta-data/ami-id)\n",
          "EOF\n",
          "chmod 600 /etc/puppetlabs/puppet/csr_attributes.yaml\n",

          "echo 'Run puppet agent for the first time'\n",
          "/opt/puppetlabs/bin/puppet agent --test --logdest syslog || true\n",

          "echo 'Start the certificates sync agent'\n",
          "mkdir -p /etc/puppetlabs/vcrt && chown -R 999:999 /etc/puppetlabs/vcrt\n",
          "docker run --name vcrt-sync-agent",
          "  --restart unless-stopped -d",
          "  --hostname vcrt-sync-agent",
          "  --user 999:999",
          "  -v /etc/puppetlabs/vcrt:/watch",
          "  vladgh/s3sync:latest",
          "  ", {"Ref": "CASSLS3Path"}, "\n",

          "echo 'Start the logging agent'\n",
          "docker run --name logging-agent",
          "  --restart unless-stopped -d",
          "  --hostname logging-agent",
          "  -v /var/run/docker.sock:/var/run/docker.sock",
          "  gliderlabs/logspout",
          "  syslog://", {"Ref": "LogServer"}, ":", {"Ref": "LogPort"}, "\n",

          "echo 'Start the ECS agent'\n",
          "mkdir -p /var/lib/ecs/data; mkdir -p /var/log/ecs\n",
          "docker run --name ecs-agent",
          "  --privileged",
          "  --restart on-failure:10 -d",
          "  -v /var/run/docker.sock:/var/run/docker.sock",
          "  -v /var/log/ecs/:/log:Z",
          "  -v /var/lib/ecs/data:/data:Z",
          "  -v /var/lib/docker:/var/lib/docker",
          "  -v /sys/fs/cgroup:/sys/fs/cgroup:ro",
          "  -v /run/runc:/var/lib/docker/execdriver/native:ro",
          "  -p 51678:51678",
          "  -e ECS_LOGFILE=/log/ecs-agent.log",
          "  -e ECS_LOGLEVEL=info",
          "  -e ECS_DATADIR=/data",
          "  -e ECS_CLUSTER=", {"Ref": "ECSCluster"},
          "  --hostname ecs-agent",
          "  amazon/amazon-ecs-agent:latest\n",

          "echo 'SUCCEEDED' | tee /var/lib/cloud/instance/status_cfn"
        ]]}}
      }
    },

    "ECSCluster": {
      "Type": "AWS::ECS::Cluster"
    },
    "ECSTaskDefinition": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties": {
        "ContainerDefinitions": [
          {
            "Name": "PuppetServer",
            "Image": "vladgh/puppetserver:latest",
            "Cpu": "512",
            "Memory": "512",
            "Essential": "true",
            "PortMappings": [
              {"ContainerPort": "8140", "HostPort": "8140"}
            ],
            "Hostname": "puppet.ghn.me",
            "MountPoints": [
              {
                "SourceVolume": "PuppetServerCode",
                "ContainerPath": "/etc/puppetlabs/code"
              },{
                "SourceVolume": "PuppetCA",
                "ContainerPath": "/etc/puppetlabs/puppet/ssl"
              },{
                "SourceVolume": "PuppetCSR",
                "ContainerPath": "/etc/puppetlabs/csr"
              }
            ],
            "Environment": [
              {"Name": "JAVA_ARGS", "Value": "-Xms256m -Xmx512m"}
            ]
          }
        ],
        "Volumes": [
          {
            "Name": "PuppetServerCode",
            "Host": {"SourcePath": "/etc/puppetlabs/code"}
          },{
            "Name": "PuppetCA",
            "Host": {"SourcePath": "/etc/puppetlabs/vcrt"}
          },{
            "Name": "PuppetCSR",
            "Host": {"SourcePath": "/etc/puppetlabs/csr"}
          }
        ]
      }
    },
    "ECSService": {
      "Type": "AWS::ECS::Service",
      "DependsOn": ["Zeus"],
      "Properties": {
        "Cluster": {"Ref": "ECSCluster"},
        "DesiredCount": {"Ref": "PuppetServerDesiredCount"},
        "DeploymentConfiguration": {
          "MaximumPercent" : "100",
          "MinimumHealthyPercent" : "0"
        },
        "LoadBalancers": [
          {
            "ContainerName": "PuppetServer",
            "ContainerPort": "8140",
            "LoadBalancerName": {"Ref": "ELB"}
          }
        ],
        "Role": {"Fn::GetAtt": ["IAM", "Outputs.ECSServiceRole"]},
        "TaskDefinition": {"Ref": "ECSTaskDefinition"}
      }
    },

    "VPC": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {"Fn::Join": ["/", ["https://s3.amazonaws.com", {"Ref": "AssetsBucket"}, {"Ref": "AssetsKeyPrefix"}, "cfn", {"Ref": "VPCTemplateKey"}]]}
      }
    },

    "SG": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {"Fn::Join": ["/", ["https://s3.amazonaws.com", {"Ref": "AssetsBucket"}, {"Ref": "AssetsKeyPrefix"}, "cfn", {"Ref": "SGTemplateKey"}]]},
        "Parameters": {
          "VPCId": {"Fn::GetAtt": ["VPC", "Outputs.VPCId"]},
          "SSHLocations": {"Fn::Join": [",", {"Ref": "SSHLocations"}]}
        }
      }
    },

    "IAM": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {"Fn::Join": ["/", ["https://s3.amazonaws.com", {"Ref": "AssetsBucket"}, {"Ref": "AssetsKeyPrefix"}, "cfn", {"Ref": "IAMTemplateKey"}]]},
        "Parameters": {
          "AssetsBucket": {"Ref": "AssetsBucket"}
        }
      }
    },

    "RDS": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {"Fn::Join": ["/", ["https://s3.amazonaws.com", {"Ref": "AssetsBucket"}, {"Ref": "AssetsKeyPrefix"}, "cfn", {"Ref": "RDSTemplateKey"}]]},
        "Parameters": {
          "EnvType": {"Ref": "EnvType"},
          "SubnetIDs": {"Fn::Join": [",", [
            {"Fn::GetAtt": ["VPC", "Outputs.Subnet1"]},
            {"Fn::GetAtt": ["VPC", "Outputs.Subnet2"]},
            {"Fn::GetAtt": ["VPC", "Outputs.Subnet3"]},
            {"Fn::GetAtt": ["VPC", "Outputs.Subnet4"]}
          ]]},
          "SecurityGroups": {"Fn::GetAtt": ["SG", "Outputs.DBSecurityGroup"]},
          "DBEngine": {"Ref": "DBEngine"},
          "DBName": {"Ref": "DBName"},
          "DBUser": {"Ref": "DBUser"},
          "DBPassword": {"Ref": "DBPassword"}
        }
      }
    }
  },

  "Outputs": {
    "LoadBalancerURL": {
      "Description": "URL - The Load Balancer Public DNS",
      "Value": {"Fn::Join": ["", ["https://", {"Fn::GetAtt": ["ELB", "DNSName"]}]]}
    },
    "ZeusASGName": {
      "Description": "The autoscaling group name",
      "Value": {"Ref": "Zeus"}
    },
    "InstanceProfileName": {
      "Description": "The instance profile name",
      "Value": {"Fn::GetAtt": ["IAM", "Outputs.InstanceProfileName"]}
    },
    "CodeDeployServiceRole": {
      "Description": "The CodeDeploy service role ARN",
      "Value": {"Fn::GetAtt": ["IAM", "Outputs.CodeDeployServiceRole"]}
    },
    "ECSCluster": {
      "Value": {"Ref": "ECSCluster"}
    },
    "ECSTaskDefinition": {
      "Value": {"Ref": "ECSTaskDefinition"}
    },
    "ECSService": {
      "Value": {"Ref": "ECSService"}
    },
    "ECSServiceRole": {
      "Description": "The ECS service role ARN",
      "Value": {"Fn::GetAtt": ["IAM", "Outputs.ECSServiceRole"]}
    }
  }
}
